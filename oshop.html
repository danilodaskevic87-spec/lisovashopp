<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–û–Ω–ª–∞–π–Ω –º–∞–≥–∞–∑–∏–Ω</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(160deg,#020617,#0f172a);
  color:#e5e7eb;
  min-height:100vh;
  padding:20px;
}
h2{text-align:center}
.balance{
  max-width:500px;
  margin:0 auto 16px;
  padding:14px;
  background:#020617;
  border:1px solid #334155;
  border-radius:14px;
  text-align:center;
}
.products{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
  max-width:1000px;
  margin:0 auto;
}
.product{
  background:#020617;
  border:1px solid #334155;
  border-radius:16px;
  padding:16px;
  text-align:center;
}
.price{font-size:18px;margin:6px 0}
.stock{font-size:14px;color:#94a3b8;margin-bottom:8px}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#022c22;
  font-weight:700;
  cursor:pointer;
}
button:disabled{
  background:#334155;
  color:#94a3b8;
  cursor:not-allowed;
}
.msg{
  text-align:center;
  margin-top:14px;
  font-weight:600;
}
</style>
</head>
<body>

<h2>üõí –û–Ω–ª–∞–π–Ω –º–∞–≥–∞–∑–∏–Ω</h2>

<div class="balance" id="balanceBox">‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É...</div>

<div class="products" id="products"></div>

<div class="msg" id="msg"></div>

<script>
/* === Supabase === */
const sb = supabase.createClient(
  'https://mefzopeenhfdqfatbjaq.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lZnpvcGVlbmhmZHFmYXRiamFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxOTg1MjQsImV4cCI6MjA4Mjc3NDUyNH0.l_yS9Vd18eb9VFs8i9u-jl9604eUY4l42tdfXEjOdhI'
)

/* === AUTH === */
async function checkAuth(){
  const { data } = await sb.auth.getUser()
  if(!data.user) location.href='index.html'
  return data.user
}

/* === BALANCE === */
async function loadBalance(user){
  const { data } = await sb
    .from('bank')
    .select('balance')
    .eq('user_id',user.id)
    .maybeSingle()

  balanceBox.textContent = 'üí∞ –ë–∞–ª–∞–Ω—Å: ' + data.balance + ' üí∏'
}

/* === PRODUCTS === */
async function loadProducts(){
  const { data } = await sb
    .from('products')
    .select('name,price,stock')

  products.innerHTML=''

  data.forEach(p=>{
    const div=document.createElement('div')
    div.className='product'
    div.innerHTML=`
      <h3>${p.name}</h3>
      <div class="price">üí∞ ${p.price}</div>
      <div class="stock">üì¶ –í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ: ${p.stock}</div>
      <button ${p.stock<=0?'disabled':''}
        onclick="buy('${p.name}')">
        ${p.stock>0?'–ö—É–ø–∏—Ç–∏':'–ù–µ–º–∞—î'}
      </button>
    `
    products.appendChild(div)
  })
}

/* === BUY (FIXED) === */
async function buy(name){
  msg.textContent = '‚è≥ –û–±—Ä–æ–±–∫–∞ –ø–æ–∫—É–ø–∫–∏...'

  const { data, error } = await sb.rpc('buy_product',{
    p_product_name: name
  })

  if(error){
    msg.textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'
    return
  }

  if(data === 'SUCCESS'){
    msg.textContent = '‚úÖ –ü–æ–∫—É–ø–∫–∞ —É—Å–ø—ñ—à–Ω–∞!'
    const user = (await sb.auth.getUser()).data.user
    await loadBalance(user)
    await loadProducts()
  }
  else if(data === 'NOT_ENOUGH_MONEY'){
    msg.textContent = 'üö´ –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤'
  }
  else if(data === 'OUT_OF_STOCK'){
    msg.textContent = 'üì¶ –¢–æ–≤–∞—Ä –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è'
    await loadProducts()
  }
  else{
    msg.textContent = '‚ùå –ù–µ–º–æ–∂–ª–∏–≤–æ –∫—É–ø–∏—Ç–∏'
  }
}

/* === INIT === */
(async ()=>{
  const user = await checkAuth()
  await loadBalance(user)
  await loadProducts()
})()
</script>

</body>
</html>
