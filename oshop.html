<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–û–Ω–ª–∞–π–Ω –º–∞–≥–∞–∑–∏–Ω</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(160deg,#020617,#0f172a);
  color:#e5e7eb;
  min-height:100vh;
  padding:20px;
}
.products{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}
.product{
  background:#020617;
  border:1px solid #334155;
  border-radius:16px;
  padding:16px;
  text-align:center;
}
.price{font-size:18px;margin:6px 0}
.desc{font-size:14px;color:#cbd5f5;margin:6px 0}
.stock{font-size:14px;color:#94a3b8;margin-bottom:8px}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#22c55e;
  color:#022c22;
  font-weight:700;
}
button:disabled{
  background:#334155;
  color:#94a3b8;
}
.msg{text-align:center;margin-top:14px;font-weight:600}
</style>
</head>
<body>

<h2 style="text-align:center">üõí –û–Ω–ª–∞–π–Ω –º–∞–≥–∞–∑–∏–Ω</h2>

<div class="products" id="products"></div>
<div class="msg" id="msg"></div>

<script>
const sb = supabase.createClient(
  'https://mefzopeenhfdqfatbjaq.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lZnpvcGVlbmhmZHFmYXRiamFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxOTg1MjQsImV4cCI6MjA4Mjc3NDUyNH0.l_yS9Vd18eb9VFs8i9u-jl9604eUY4l42tdfXEjOdhI'
)

async function checkAuth(){
  const { data } = await sb.auth.getUser()
  if(!data.user) location.href='index.html'
}

async function loadProducts(){
  const { data } = await sb
    .from('products')
    .select('name,price,stock,description,is_bezlim')

  products.innerHTML=''

  data.forEach(p=>{
    const d=document.createElement('div')
    d.className='product'
    d.innerHTML=`
      <h3>${p.name}</h3>
      <div class="price">üí∞ ${p.price}</div>
      <div class="desc">${p.description ?? ''}</div>
      ${p.is_bezlim ? `` : `<div class="stock">üì¶ –í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ: ${p.stock}</div>`}
      <button ${(!p.is_bezlim && p.stock<=0) ? 'disabled' : ''}
        onclick="buy('${p.name}')">
        ${(!p.is_bezlim && p.stock<=0) ? '–ù–µ–º–∞—î' : '–ö—É–ø–∏—Ç–∏'}
      </button>
    `
    products.appendChild(d)
  })
}

async function buy(name){
  msg.textContent='‚è≥ –ü–æ–∫—É–ø–∫–∞...'
  const { data } = await sb.rpc('buy_product',{ p_product_name:name })

  if(data==='SUCCESS'){
    msg.textContent='‚úÖ –ü–æ–∫—É–ø–∫–∞ —É—Å–ø—ñ—à–Ω–∞'
    loadProducts()
  }else if(data==='NOT_ENOUGH_MONEY'){
    msg.textContent='üö´ –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤'
  }else if(data==='OUT_OF_STOCK'){
    msg.textContent='üì¶ –¢–æ–≤–∞—Ä –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è'
    loadProducts()
  }
}

checkAuth()
loadProducts()
setInterval(loadProducts,5000)
</script>

</body>
</html>
